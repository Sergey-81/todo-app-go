<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Todo App</title>
    <style>
        body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;background-color:#f9f9f9;}
        .task{margin:12px 0;padding:12px;border-left:4px solid #2196F3;background:white;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;transition:all 0.3s ease;}
        .task.completed{border-left-color:#4CAF50;opacity:0.7;background-color:#f5f5f5;}
        .task-content{flex-grow:1;margin-right:10px;}
        .task-description{word-break:break-word;margin-bottom:5px;}
        .task-actions{display:flex;gap:5px;flex-wrap:wrap;}
        input,select{padding:8px;border:1px solid #ddd;border-radius:4px;}
        button{padding:8px 12px;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:background 0.2s;}
        #add-button{background-color:#4CAF50;color:white;}
        #add-button:hover{background-color:#388E3C;}
        .complete-button{background-color:#ff9800;color:white;}
        .complete-button:hover{background-color:#e68a00;}
        .edit-button{background-color:#2196F3;color:white;cursor:pointer;}
        .edit-button:hover{background-color:#0b7dda;}
        .delete-button{background-color:#f44336;color:white;}
        .delete-button:hover{background-color:#d32f2f;}
        .task-form{margin-bottom:20px;display:flex;gap:5px;flex-wrap:wrap;}
        .edit-form{display:none;width:100%;margin-top:10px;gap:5px;flex-wrap:wrap;}
        .filters{margin:15px 0;display:flex;gap:10px;flex-wrap:wrap;}
        .filter-btn{padding:8px 12px;background:#e0e0e0;border-radius:4px;text-decoration:none;color:#333;transition:background 0.2s;}
        .filter-btn:hover{background:#d0d0d0;}
        .active-filter{background:#2196F3;color:white;}
        h1{color:#333;text-align:center;}
        .priority{font-size:0.8em;padding:2px 6px;border-radius:10px;margin-right:8px;color:white;}
        .priority-low{background-color:#4CAF50;}
        .priority-medium{background-color:#FFC107;color:black;}
        .priority-high{background-color:#F44336;}
        .due-date{font-size:0.8em;color:#666;}
        .due-date.soon{color:#E91E63;font-weight:bold;}
        .due-date.overdue{color:#F44336;font-weight:bold;}
        .task-info{display:flex;align-items:center;flex-wrap:wrap;margin-top:5px;}
        .tag{display:inline-block;background:#e0e0e0;padding:2px 8px;border-radius:10px;font-size:0.8em;margin-right:5px;}
        .tags-container{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px;}
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–µ */
        .date-filter-container input[type="date"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            cursor: pointer;
        }
        
        .date-filter-container input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .date-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .calendar-icon {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            color: #666;
            pointer-events: none;
        }
        
        .calendar-icon:hover {
            color: #2196F3;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥–∑–∞–¥–∞—á */
        .subtasks {
            width: 100%;
            margin-top: 10px;
            padding-left: 20px;
            border-left: 2px solid #ddd;
        }
        
        .subtask {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .subtask.completed {
            opacity: 0.7;
        }
        
        .subtask.completed .subtask-description {
            text-decoration: line-through;
            color: #888;
        }
        
        .subtask-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }
        
        .subtask-input-container {
            width: 100%;
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        
        .subtask-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .add-subtask-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .add-subtask-btn:hover {
            background-color: #388E3C;
        }
        
        .toggle-subtasks-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        
        .toggle-subtasks-btn:hover {
            color: #2196F3;
        }
        
        .toggle-subtasks-btn::before {
            content: "‚ñ∂";
            font-size: 10px;
            margin-right: 5px;
            transition: transform 0.2s;
        }
        
        .toggle-subtasks-btn.expanded::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <h1>–ú–æ–∏ –∑–∞–¥–∞—á–∏</h1>
    <form class="task-form" method="POST" action="/tasks">
        <input type="text" name="description" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." required style="flex-grow:1;">
        <select name="priority" style="width:120px;">
            <option value="low">–ù–∏–∑–∫–∏–π</option>
            <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
        </select>
        <input type="date" name="due_date" style="width:150px;">
        <input type="text" name="tags" placeholder="—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" style="width:200px;">
        <button id="add-button" type="submit">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
    
    <div class="filters">
        <a href="/tasks/filter/all" class="filter-btn">–í—Å–µ –∑–∞–¥–∞—á–∏</a>
        <a href="/tasks/filter/active" class="filter-btn">–ê–∫—Ç–∏–≤–Ω—ã–µ</a>
        <a href="/tasks/filter/completed" class="filter-btn">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</a>
        <div style="display:flex;gap:10px;">
            <a href="/tasks/priority/low" class="filter-btn">–ù–∏–∑–∫–∏–π</a>
            <a href="/tasks/priority/medium" class="filter-btn">–°—Ä–µ–¥–Ω–∏–π</a>
            <a href="/tasks/priority/high" class="filter-btn">–í—ã—Å–æ–∫–∏–π</a>
        </div>
        <a href="/tasks/upcoming/7" class="filter-btn">–ù–∞ –Ω–µ–¥–µ–ª–µ</a>
        
        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
        <div class="date-filter-container">
            <form method="GET" action="/tasks/filter/date" class="date-filter-form" id="dateFilterForm">
                <span>–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ:</span>
                
                <div class="date-input-wrapper">
                    <input type="text" name="start" id="startDate" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" 
                           pattern="\d{2}\.\d{2}\.\d{4}" title="–§–æ—Ä–º–∞—Ç: –¥–¥.–º–º.–≥–≥–≥–≥">
                    <button type="button" class="calendar-icon" onclick="showDatePicker('startDate')">üìÖ</button>
                </div>
                
                <span>-</span>
                
                <div class="date-input-wrapper">
                    <input type="text" name="end" id="endDate" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥"
                           pattern="\d{2}\.\d{2}\.\d{4}" title="–§–æ—Ä–º–∞—Ç: –¥–¥.–º–º.–≥–≥–≥–≥">
                    <button type="button" class="calendar-icon" onclick="showDatePicker('endDate')">üìÖ</button>
                </div>
                
                <button type="submit" class="filter-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <a href="/" class="filter-btn">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </form>
        </div>
        
        {{if gt (len (getPopularTags .Tasks)) 0}}
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:10px;width:100%;">
            <strong style="align-self:center;">–¢–µ–≥–∏:</strong>
            {{range $tag := getPopularTags .Tasks}}
                <a href="/tasks/tag/{{$tag | urlquery}}" class="filter-btn">{{$tag}}</a>
            {{end}}
        </div>
        {{end}}
    </div>
    
    <div id="task-list">
        {{range .Tasks}}
        <div class="task {{if .Completed}}completed{{end}}" id="task-{{.ID}}">
            <div class="task-content">
                <div class="task-description">{{.Description}}</div>
                <div class="task-info">
                    <span class="priority priority-{{.Priority}}">
                        {{if eq .Priority "low"}}–ù–∏–∑–∫–∏–π{{else if eq .Priority "medium"}}–°—Ä–µ–¥–Ω–∏–π{{else}}–í—ã—Å–æ–∫–∏–π{{end}}
                    </span>
                    {{if not .DueDate.IsZero}}
                    <span class="due-date {{if .DueDate.Before (now)}}overdue{{else if lt (daysLeft .DueDate) 3}}soon{{end}}">
                        üìÖ {{.DueDate.Format "02.01.2006"}}
                    </span>
                    {{end}}
                </div>
                {{if .Tags}}
                <div class="tags-container">
                    {{range .Tags}}
                    <span class="tag">{{.}}</span>
                    {{end}}
                </div>
                {{end}}
                
                <button class="toggle-subtasks-btn" onclick="toggleSubtasks('{{.ID}}')">–ü–æ–¥–∑–∞–¥–∞—á–∏</button>
                
                <div class="subtasks" id="subtasks-{{.ID}}" style="display:none;">
                    <!-- –ü–æ–¥–∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                </div>
                
                <div class="subtask-input-container">
                    <input type="text" class="subtask-input" id="subtask-input-{{.ID}}" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É">
                    <button class="add-subtask-btn" onclick="addSubtask('{{.ID}}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                
                <div class="task-actions">
                    <form method="POST" action="/tasks/toggle/{{.ID}}" style="display:inline;">
                        <button type="submit" class="complete-button">
                            {{if .Completed}}‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ{{else}}‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ{{end}}
                        </button>
                    </form>
                    <button class="edit-button" onclick='showEditForm("{{.ID}}","{{.Description | js}}","{{.Priority}}","{{if not .DueDate.IsZero}}{{.DueDate.Format `2006-01-02`}}{{end}}","{{range $i,$tag:=.Tags}}{{if $i}},{{end}}{{$tag}}{{end}}")'>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <form method="POST" action="/tasks/delete/{{.ID}}" style="display:inline;">
                        <button type="submit" class="delete-button">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </div>
            </div>
            
            <form class="edit-form" id="edit-form-{{.ID}}" method="POST" action="/tasks/update/{{.ID}}">
                <input type="text" name="description" value="{{.Description}}" required style="flex-grow:1;">
                <select name="priority" style="width:120px;">
                    {{if eq .Priority "low"}}<option value="low" selected>–ù–∏–∑–∫–∏–π</option>{{else}}<option value="low">–ù–∏–∑–∫–∏–π</option>{{end}}
                    {{if eq .Priority "medium"}}<option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>{{else}}<option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>{{end}}
                    {{if eq .Priority "high"}}<option value="high" selected>–í—ã—Å–æ–∫–∏–π</option>{{else}}<option value="high">–í—ã—Å–æ–∫–∏–π</option>{{end}}
                </select>
                {{if not .DueDate.IsZero}}<input type="date" name="due_date" value="{{.DueDate.Format `2006-01-02`}}" style="width:150px;">{{else}}<input type="date" name="due_date" style="width:150px;">{{end}}
                <input type="text" name="tags" value="{{range $i,$tag:=.Tags}}{{if $i}},{{end}}{{$tag}}{{end}}" placeholder="—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" style="width:200px;">
                <button class="edit-button" type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="delete-button" onclick="hideEditForm('{{.ID}}')">‚úñ –û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
        {{end}}
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á
        function showEditForm(id, description, priority, dueDate, tags) {
            const taskElement = document.getElementById('task-' + id);
            if (!taskElement) return;
            
            const elementsToHide = [
                taskElement.querySelector('.task-description'),
                taskElement.querySelector('.task-info'),
                taskElement.querySelector('.tags-container'),
                taskElement.querySelector('.task-actions'),
                taskElement.querySelector('.toggle-subtasks-btn'),
                taskElement.querySelector('.subtasks'),
                taskElement.querySelector('.subtask-input-container')
            ];
            
            elementsToHide.forEach(el => {
                if (el) el.style.display = 'none';
            });
            
            const editForm = document.getElementById('edit-form-' + id);
            if (editForm) {
                editForm.style.display = 'flex';
                const descInput = editForm.querySelector('input[name="description"]');
                const prioritySelect = editForm.querySelector('select[name="priority"]');
                const dueDateInput = editForm.querySelector('input[name="due_date"]');
                const tagsInput = editForm.querySelector('input[name="tags"]');
                
                if (descInput) descInput.value = description || '';
                if (prioritySelect) prioritySelect.value = priority || 'medium';
                if (dueDateInput) dueDateInput.value = dueDate || '';
                if (tagsInput) tagsInput.value = tags || '';
                
                if (descInput) descInput.focus();
            }
        }

        function hideEditForm(id) {
            const taskElement = document.getElementById('task-' + id);
            if (!taskElement) return;
            
            const elementsToShow = [
                taskElement.querySelector('.task-description'),
                taskElement.querySelector('.task-info'),
                taskElement.querySelector('.tags-container'),
                taskElement.querySelector('.task-actions'),
                taskElement.querySelector('.toggle-subtasks-btn'),
                taskElement.querySelector('.subtask-input-container')
            ];
            
            elementsToShow.forEach(el => {
                if (el) el.style.display = el.classList.contains('tags-container') ? 'flex' : 
                                          el.classList.contains('task-info') ? 'flex' : 
                                          el.classList.contains('task-actions') ? 'flex' :
                                          el.classList.contains('subtask-input-container') ? 'flex' : 'block';
            });
            
            const editForm = document.getElementById('edit-form-' + id);
            if (editForm) editForm.style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–µ
        function setupDatePickers() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ input type="date" –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
            const createDatePicker = (input) => {
                const wrapper = input.parentNode;
                const datePicker = document.createElement('input');
                datePicker.type = 'date';
                datePicker.title = "–ü–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã";
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                if (input.value && input.value.match(/\d{2}\.\d{2}\.\d{4}/)) {
                    const [day, month, year] = input.value.split('.');
                    datePicker.value = `${year}-${month}-${day}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã
                datePicker.addEventListener('change', function() {
                    if (this.value) {
                        const [year, month, day] = this.value.split('-');
                        input.value = `${day}.${month}.${year}`;
                    }
                });
                
                wrapper.appendChild(datePicker);
                
                // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ —Ç–æ–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                input.addEventListener('click', function() {
                    datePicker.click();
                });
            };
            
            createDatePicker(startInput);
            createDatePicker(endInput);
        }

        function setupDateInputs() {
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('start');
            const endParam = urlParams.get('end');

            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);

            const formatToRussian = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${day}.${month}.${date.getFullYear()}`;
            };

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ –∏–∑ URL
            document.getElementById('startDate').value = startParam || formatToRussian(today);
            document.getElementById('endDate').value = endParam || formatToRussian(nextWeek);

            // –ú–∞—Å–∫–∞ –≤–≤–æ–¥–∞ –¥–ª—è –¥–∞—Ç—ã
            ['startDate', 'endDate'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function(e) {
                    let value = this.value.replace(/\D/g, '');
                    if (value.length > 8) value = value.slice(0, 8);
                    
                    let formatted = '';
                    for (let i = 0; i < value.length; i++) {
                        if (i === 2 || i === 4) formatted += '.';
                        formatted += value[i];
                    }
                    
                    this.value = formatted;
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–∑–∞–¥–∞—á–∞–º–∏
        function toggleSubtasks(taskId) {
            const subtasksContainer = document.getElementById(`subtasks-${taskId}`);
            const toggleBtn = document.querySelector(`#task-${taskId} .toggle-subtasks-btn`);
            
            if (subtasksContainer.style.display === 'none' || !subtasksContainer.style.display) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∑–∞–¥–∞—á–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if (subtasksContainer.innerHTML.trim() === '') {
                    loadSubtasks(taskId);
                }
                subtasksContainer.style.display = 'block';
                toggleBtn.classList.add('expanded');
            } else {
                subtasksContainer.style.display = 'none';
                toggleBtn.classList.remove('expanded');
            }
        }

        function loadSubtasks(taskId) {
            fetch(`/tasks/${taskId}/subtasks`)
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∑–∞–¥–∞—á');
                    return response.json();
                })
                .then(subtasks => {
                    const container = document.getElementById(`subtasks-${taskId}`);
                    if (!container) return;
                    
                    if (subtasks.length === 0) {
                        container.innerHTML = '<div style="color:#666;font-size:0.9em;">–ù–µ—Ç –ø–æ–¥–∑–∞–¥–∞—á</div>';
                        return;
                    }
                    
                    container.innerHTML = subtasks.map(subtask => `
                        <div class="subtask ${subtask.completed ? 'completed' : ''}" id="subtask-${subtask.id}">
                            <input type="checkbox" ${subtask.completed ? 'checked' : ''} 
                                   onchange="toggleSubtaskStatus(${subtask.id}, ${taskId})">
                            <span class="subtask-description">${subtask.description}</span>
                            <div class="subtask-actions">
                                <button onclick="deleteSubtask(${subtask.id}, ${taskId})" style="background:none;border:none;color:#f44336;cursor:pointer;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∑–∞–¥–∞—á:', error);
                    const container = document.getElementById(`subtasks-${taskId}`);
                    if (container) {
                        container.innerHTML = '<div style="color:#f44336;font-size:0.9em;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∑–∞–¥–∞—á</div>';
                    }
                });
        }

        function addSubtask(taskId) {
            const input = document.getElementById(`subtask-input-${taskId}`);
            const description = input.value.trim();
            if (!description) return;
            
            fetch(`/tasks/${taskId}/subtasks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `description=${encodeURIComponent(description)}`
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á–∏');
                input.value = '';
                return loadSubtasks(taskId);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É');
            });
        }

        function toggleSubtaskStatus(subtaskId, taskId) {
            fetch(`/subtasks/${subtaskId}/toggle`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á–∏');
                const subtaskElement = document.getElementById(`subtask-${subtaskId}`);
                if (subtaskElement) {
                    subtaskElement.classList.toggle('completed');
                    const description = subtaskElement.querySelector('.subtask-description');
                    if (description) {
                        description.style.textDecoration = subtaskElement.classList.contains('completed') ? 'line-through' : 'none';
                    }
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É');
            });
        }

        function deleteSubtask(subtaskId, taskId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É?')) return;
            
            fetch(`/subtasks/${subtaskId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á–∏');
                return loadSubtasks(taskId);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É');
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
            const path = window.location.pathname;
            const links = document.querySelectorAll('.filter-btn');
            
            links.forEach(link => {
                if (link && path.includes(link.getAttribute('href'))) {
                    link.classList.add('active-filter');
                }
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–µ
            setupDateInputs();
            setupDatePickers();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–¥–∞—á–∏ (—á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª–∞—Å—å)
            document.querySelector('.task-form').addEventListener('submit', function(e) {
                e.preventDefault();
                this.submit();
            });
        });
    </script>
</body>
</html>