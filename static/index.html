<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Todo App</title>
    <style>
        body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;background-color:#f9f9f9;}
        .task{margin:12px 0;padding:12px;border-left:4px solid #2196F3;background:white;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;transition:all 0.3s ease;}
        .task.completed{border-left-color:#4CAF50;opacity:0.7;background-color:#f5f5f5;}
        .task-content{flex-grow:1;margin-right:10px;}
        .task-description{word-break:break-word;margin-bottom:5px;}
        .task-actions{display:flex;gap:5px;flex-wrap:wrap;}
        input,select{padding:8px;border:1px solid #ddd;border-radius:4px;}
        button{padding:8px 12px;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:background 0.2s;}
        #add-button{background-color:#4CAF50;color:white;}
        #add-button:hover{background-color:#388E3C;}
        .complete-button{background-color:#ff9800;color:white;}
        .complete-button:hover{background-color:#e68a00;}
        .edit-button{background-color:#2196F3;color:white;cursor:pointer;}
        .edit-button:hover{background-color:#0b7dda;}
        .delete-button{background-color:#f44336;color:white;}
        .delete-button:hover{background-color:#d32f2f;}
        .task-form{margin-bottom:20px;display:flex;gap:5px;flex-wrap:wrap;}
        .edit-form{display:none;width:100%;margin-top:10px;gap:5px;flex-wrap:wrap;}
        .filters{margin:15px 0;display:flex;gap:10px;flex-wrap:wrap;}
        .filter-btn{padding:8px 12px;background:#e0e0e0;border-radius:4px;text-decoration:none;color:#333;transition:background 0.2s;}
        .filter-btn:hover{background:#d0d0d0;}
        .active-filter{background:#2196F3;color:white;}
        h1{color:#333;text-align:center;}
        .priority{font-size:0.8em;padding:2px 6px;border-radius:10px;margin-right:8px;color:white;}
        .priority-low{background-color:#4CAF50;}
        .priority-medium{background-color:#FFC107;color:black;}
        .priority-high{background-color:#F44336;}
        .due-date{font-size:0.8em;color:#666;}
        .due-date.soon{color:#E91E63;font-weight:bold;}
        .due-date.overdue{color:#F44336;font-weight:bold;}
        .task-info{display:flex;align-items:center;flex-wrap:wrap;margin-top:5px;}
        .tag{display:inline-block;background:#e0e0e0;padding:2px 8px;border-radius:10px;font-size:0.8em;margin-right:5px;}
        .tags-container{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px;}
    </style>
</head>
<body>
    <h1>–ú–æ–∏ –∑–∞–¥–∞—á–∏</h1>
    <form class="task-form" method="POST" action="/tasks">
        <input type="text" name="description" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." required style="flex-grow:1;">
        <select name="priority" style="width:120px;">
            <option value="low">–ù–∏–∑–∫–∏–π</option>
            <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
        </select>
        <input type="date" name="due_date" style="width:150px;">
        <input type="text" name="tags" placeholder="—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" style="width:200px;">
        <button id="add-button" type="submit">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
    
    <div class="filters">
        <a href="/tasks/filter/all" class="filter-btn">–í—Å–µ –∑–∞–¥–∞—á–∏</a>
        <a href="/tasks/filter/active" class="filter-btn">–ê–∫—Ç–∏–≤–Ω—ã–µ</a>
        <a href="/tasks/filter/completed" class="filter-btn">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</a>
        <div style="display:flex;gap:10px;">
            <a href="/tasks/priority/low" class="filter-btn">–ù–∏–∑–∫–∏–π</a>
            <a href="/tasks/priority/medium" class="filter-btn">–°—Ä–µ–¥–Ω–∏–π</a>
            <a href="/tasks/priority/high" class="filter-btn">–í—ã—Å–æ–∫–∏–π</a>
        </div>
        <a href="/tasks/upcoming/7" class="filter-btn">–ù–∞ –Ω–µ–¥–µ–ª–µ</a>
        {{if gt (len (getPopularTags .Tasks)) 0}}
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:10px;width:100%;">
            <strong style="align-self:center;">–¢–µ–≥–∏:</strong>
            {{range $tag := getPopularTags .Tasks}}
                <a href="/tasks/tag/{{$tag | urlquery}}" class="filter-btn">{{$tag}}</a>
            {{end}}
        </div>
        {{end}}
    </div>
    
    <div id="task-list">
        {{range .Tasks}}
        <div class="task {{if .Completed}}completed{{end}}" id="task-{{.ID}}">
            <div class="task-content">
                <div class="task-description">{{.Description}}</div>
                <div class="task-info">
                    <span class="priority priority-{{.Priority}}">
                        {{if eq .Priority "low"}}–ù–∏–∑–∫–∏–π{{else if eq .Priority "medium"}}–°—Ä–µ–¥–Ω–∏–π{{else}}–í—ã—Å–æ–∫–∏–π{{end}}
                    </span>
                    {{if not .DueDate.IsZero}}
                    <span class="due-date {{if .DueDate.Before (now)}}overdue{{else if lt (daysLeft .DueDate) 3}}soon{{end}}">
                        üìÖ {{.DueDate.Format "02.01.2006"}}
                    </span>
                    {{end}}
                </div>
                {{if .Tags}}
                <div class="tags-container">
                    {{range .Tags}}
                    <span class="tag">{{.}}</span>
                    {{end}}
                </div>
                {{end}}
                <div class="task-actions">
                    <form method="POST" action="/tasks/toggle/{{.ID}}" style="display:inline;">
                        <button type="submit" class="complete-button">
                            {{if .Completed}}‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ{{else}}‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ{{end}}
                        </button>
                    </form>
                    <button class="edit-button" onclick='showEditForm("{{.ID}}","{{.Description | js}}","{{.Priority}}","{{if not .DueDate.IsZero}}{{.DueDate.Format `2006-01-02`}}{{end}}","{{range $i,$tag:=.Tags}}{{if $i}},{{end}}{{$tag}}{{end}}")'>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <form method="POST" action="/tasks/delete/{{.ID}}" style="display:inline;">
                        <button type="submit" class="delete-button">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </div>
            </div>
            
            <form class="edit-form" id="edit-form-{{.ID}}" method="POST" action="/tasks/update/{{.ID}}">
                <input type="text" name="description" value="{{.Description}}" required style="flex-grow:1;">
                <select name="priority" style="width:120px;">
                    {{if eq .Priority "low"}}<option value="low" selected>–ù–∏–∑–∫–∏–π</option>{{else}}<option value="low">–ù–∏–∑–∫–∏–π</option>{{end}}
                    {{if eq .Priority "medium"}}<option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>{{else}}<option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>{{end}}
                    {{if eq .Priority "high"}}<option value="high" selected>–í—ã—Å–æ–∫–∏–π</option>{{else}}<option value="high">–í—ã—Å–æ–∫–∏–π</option>{{end}}
                </select>
                {{if not .DueDate.IsZero}}<input type="date" name="due_date" value="{{.DueDate.Format `2006-01-02`}}" style="width:150px;">{{else}}<input type="date" name="due_date" style="width:150px;">{{end}}
                <input type="text" name="tags" value="{{range $i,$tag:=.Tags}}{{if $i}},{{end}}{{$tag}}{{end}}" placeholder="—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" style="width:200px;">
                <button class="edit-button" type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="delete-button" onclick="hideEditForm('{{.ID}}')">‚úñ –û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
        {{end}}
    </div>

    <script>
        function showEditForm(id, description, priority, dueDate, tags) {
            const taskElement = document.getElementById('task-' + id);
            if (!taskElement) return;
            
            const elementsToHide = [
                taskElement.querySelector('.task-description'),
                taskElement.querySelector('.task-info'),
                taskElement.querySelector('.tags-container'),
                taskElement.querySelector('.task-actions')
            ];
            
            elementsToHide.forEach(el => {
                if (el) el.style.display = 'none';
            });
            
            const editForm = document.getElementById('edit-form-' + id);
            if (editForm) {
                editForm.style.display = 'flex';
                const descInput = editForm.querySelector('input[name="description"]');
                const prioritySelect = editForm.querySelector('select[name="priority"]');
                const dueDateInput = editForm.querySelector('input[name="due_date"]');
                const tagsInput = editForm.querySelector('input[name="tags"]');
                
                if (descInput) descInput.value = description || '';
                if (prioritySelect) prioritySelect.value = priority || 'medium';
                if (dueDateInput) dueDateInput.value = dueDate || '';
                if (tagsInput) tagsInput.value = tags || '';
                
                if (descInput) descInput.focus();
            }
        }

        function hideEditForm(id) {
            const taskElement = document.getElementById('task-' + id);
            if (!taskElement) return;
            
            const elementsToShow = [
                taskElement.querySelector('.task-description'),
                taskElement.querySelector('.task-info'),
                taskElement.querySelector('.tags-container'),
                taskElement.querySelector('.task-actions')
            ];
            
            elementsToShow.forEach(el => {
                if (el) el.style.display = el.classList.contains('tags-container') ? 'flex' : 
                                          el.classList.contains('task-info') ? 'flex' : 'block';
            });
            
            const editForm = document.getElementById('edit-form-' + id);
            if (editForm) editForm.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const path = window.location.pathname;
            const links = document.querySelectorAll('.filter-btn');
            
            links.forEach(link => {
                if (link && path.includes(link.getAttribute('href'))) {
                    link.classList.add('active-filter');
                }
            });
        });
    </script>
</body>
</html>