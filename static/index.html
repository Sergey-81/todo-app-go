<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Todo App</title>
    <style>
        body{font-family:Arial,sans-serif;max-width:1000px;margin:0 auto;padding:20px;background-color:#f9f9f9;}
        .task{margin:12px 0;padding:12px;border-left:4px solid #2196F3;background:white;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;transition:all 0.3s ease;}
        .task.completed{border-left-color:#4CAF50;opacity:0.7;background-color:#f5f5f5;}
        .task-content{flex-grow:1;margin-right:10px;}
        .task-description{word-break:break-word;margin-bottom:5px;}
        .task-actions{display:flex;gap:5px;flex-wrap:wrap;}
        input,select{padding:8px;border:1px solid #ddd;border-radius:4px;}
        button{padding:8px 12px;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:background 0.2s;}
        #add-button{background-color:#4CAF50;color:white;}
        #add-button:hover{background-color:#388E3C;}
        .complete-button{background-color:#ff9800;color:white;}
        .complete-button:hover{background-color:#e68a00;}
        .edit-button{background-color:#2196F3;color:white;cursor:pointer;}
        .edit-button:hover{background-color:#0b7dda;}
        .delete-button{background-color:#f44336;color:white;}
        .delete-button:hover{background-color:#d32f2f;}
        .task-form{margin-bottom:20px;display:flex;gap:5px;flex-wrap:wrap;}
        .edit-form{display:none;width:100%;margin-top:10px;gap:5px;flex-wrap:wrap;}
        h1{color:#333;text-align:center;}
        .priority{font-size:0.8em;padding:2px 6px;border-radius:10px;margin-right:8px;color:white;}
        .priority-low{background-color:#4CAF50;}
        .priority-medium{background-color:#FFC107;color:black;}
        .priority-high{background-color:#F44336;}
        .due-date{font-size:0.8em;color:#666;}
        .due-date.soon{color:#E91E63;font-weight:bold;}
        .due-date.overdue{color:#F44336;font-weight:bold;}
        .task-info{display:flex;align-items:center;flex-wrap:wrap;margin-top:5px;}
        .tag{display:inline-block;background:#e0e0e0;padding:2px 8px;border-radius:10px;font-size:0.8em;margin-right:5px;}
        .tags-container{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px;}
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥–∑–∞–¥–∞—á */
        .subtasks {
            width: 100%;
            margin-top: 10px;
            padding-left: 20px;
            border-left: 2px solid #ddd;
        }
        
        .subtask {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .subtask.completed {
            opacity: 0.7;
        }
        
        .subtask.completed .subtask-description {
            text-decoration: line-through;
            color: #888;
        }
        
        .subtask-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }
        
        .subtask-input-container {
            width: 100%;
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        
        .subtask-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .add-subtask-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .add-subtask-btn:hover {
            background-color: #388E3C;
        }
        
        .toggle-subtasks-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        
        .toggle-subtasks-btn:hover {
            color: #2196F3;
        }
        
        .toggle-subtasks-btn::before {
            content: "‚ñ∂";
            font-size: 10px;
            margin-right: 5px;
            transition: transform 0.2s;
        }
        
        .toggle-subtasks-btn.expanded::before {
            transform: rotate(90deg);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
        .advanced-filters {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .advanced-filters.active {
            border-color: #28a745;
            background-color: #f0fff4;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .filter-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }

        .date-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .calendar-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            padding: 8px;
            margin-left: 5px;
            border-radius: 4px;
            background: #f0f0f0;
        }

        .calendar-icon:hover {
            background: #e0e0e0;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .quick-filters {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .quick-filter-btn {
            padding: 8px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .quick-filter-btn:hover {
            background: #5a6268;
        }

        .apply-btn {
            background: #28a745;
        }

        .apply-btn:hover {
            background: #218838;
        }

        .reset-btn {
            background: #dc3545;
        }

        .reset-btn:hover {
            background: #c82333;
        }

        .all-tasks-btn {
            background: #17a2b8;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            padding: 10px 15px;
        }

        .all-tasks-btn:hover {
            background: #138496;
            color: white;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á */
        .subtasks-summary {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .subtasks-progress {
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }

        .progress-text {
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <h1>–ú–æ–∏ –∑–∞–¥–∞—á–∏</h1>
    
    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <form class="task-form" method="POST" action="/tasks">
        <input type="text" name="description" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." required style="flex-grow:1;">
        <select name="priority" style="width:120px;">
            <option value="low">–ù–∏–∑–∫–∏–π</option>
            <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
        </select>
        <input type="date" name="due_date" style="width:150px;">
        <input type="text" name="tags" placeholder="—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" style="width:200px;">
        <button id="add-button" type="submit">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </form>

    <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è -->
    <div class="advanced-filters" id="advancedFilters">
        <h3 style="margin-top: 0; color: #333; display: flex; align-items: center;">
            <span style="margin-right: 10px;">üéØ</span>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á
        </h3>
        
        <form method="GET" action="/tasks/filter/advanced" id="advancedFilterForm">
            <div class="filter-grid">
                <!-- –°—Ç–∞—Ç—É—Å -->
                <div class="filter-group">
                    <label class="filter-label">–°—Ç–∞—Ç—É—Å:</label>
                    <select name="completed" class="filter-input">
                        <option value="">–í—Å–µ –∑–∞–¥–∞—á–∏</option>
                        <option value="false">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="true">‚òëÔ∏è –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                
                <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                <div class="filter-group">
                    <label class="filter-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                    <select name="priority" class="filter-input">
                        <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                        <option value="low">üîµ –ù–∏–∑–∫–∏–π</option>
                        <option value="medium">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option>
                    </select>
                </div>
                
                <!-- –¢–µ–≥–∏ -->
                <div class="filter-group">
                    <label class="filter-label">–¢–µ–≥–∏:</label>
                    <input type="text" name="tags" placeholder="—Ä–∞–±–æ—Ç–∞,–ª–∏—á–Ω–æ–µ,–ø–æ–∫—É–ø–∫–∏" class="filter-input">
                </div>
                
                <!-- –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ -->
                <div class="filter-group">
                    <label class="filter-label">–î–∞—Ç–∞ —Å:</label>
                    <div class="date-input-wrapper">
                        <input type="text" name="start_date" id="startDate" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" 
                               pattern="\d{2}\.\d{2}\.\d{4}" class="filter-input" style="flex-grow:1;">
                        <button type="button" class="calendar-icon" onclick="showDatePicker('startDate')">üìÖ</button>
                    </div>
                </div>
                
                <!-- –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
                <div class="filter-group">
                    <label class="filter-label">–î–∞—Ç–∞ –ø–æ:</label>
                    <div class="date-input-wrapper">
                        <input type="text" name="end_date" id="endDate" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥"
                               pattern="\d{2}\.\d{2}\.\d{4}" class="filter-input" style="flex-grow:1;">
                        <button type="button" class="calendar-icon" onclick="showDatePicker('endDate')">üìÖ</button>
                    </div>
                </div>
                
                <!-- –ù–∞–ª–∏—á–∏–µ –¥–∞—Ç—ã -->
                <div class="filter-group">
                    <label class="filter-label">–î–∞—Ç–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
                    <select name="has_due_date" class="filter-input">
                        <option value="">–í—Å–µ –∑–∞–¥–∞—á–∏</option>
                        <option value="true">üìÖ –¢–æ–ª—å–∫–æ —Å –¥–∞—Ç–æ–π</option>
                        <option value="false">‚è≥ –ë–µ–∑ –¥–∞—Ç—ã</option>
                    </select>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="filter-buttons">
                <button type="submit" class="quick-filter-btn apply-btn">
                    üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
                
                <button type="button" onclick="resetAdvancedFilters()" class="quick-filter-btn reset-btn">
                    üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å
                </button>
                
                <a href="/" class="quick-filter-btn all-tasks-btn">
                    üìã –í—Å–µ –∑–∞–¥–∞—á–∏
                </a>
            </div>
        </form>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="quick-filters">
        <button onclick="applyQuickFilter('active_high')" class="quick-filter-btn">
            üî• –ê–∫—Ç–∏–≤–Ω—ã–µ + –í—ã—Å–æ–∫–∏–π
        </button>
        <button onclick="applyQuickFilter('active_week')" class="quick-filter-btn">
            üìÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞ –Ω–µ–¥–µ–ª—é
        </button>
        <button onclick="applyQuickFilter('no_date')" class="quick-filter-btn">
            ‚è≥ –ó–∞–¥–∞—á–∏ –±–µ–∑ –¥–∞—Ç—ã
        </button>
        <button onclick="applyQuickFilter('active_medium')" class="quick-filter-btn">
            ‚ö° –ê–∫—Ç–∏–≤–Ω—ã–µ + –°—Ä–µ–¥–Ω–∏–π
        </button>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
    <div id="task-list">
        {{range .Tasks}}
        <div class="task {{if .Completed}}completed{{end}}" id="task-{{.ID}}">
            <div class="task-content">
                <div class="task-description">{{.Description}}</div>
                <div class="task-info">
                    <span class="priority priority-{{.Priority}}">
                        {{if eq .Priority "low"}}–ù–∏–∑–∫–∏–π{{else if eq .Priority "medium"}}–°—Ä–µ–¥–Ω–∏–π{{else}}–í—ã—Å–æ–∫–∏–π{{end}}
                    </span>
                    {{if not .DueDate.IsZero}}
                    <span class="due-date {{if .DueDate.Before (now)}}overdue{{else if lt (daysLeft .DueDate) 3}}soon{{end}}">
                        üìÖ {{.DueDate.Format "02.01.2006"}}
                    </span>
                    {{end}}
                </div>
                {{if .Tags}}
                <div class="tags-container">
                    {{range .Tags}}
                    <span class="tag">{{.}}</span>
                    {{end}}
                </div>
                {{end}}
                
                <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∑–∞–¥–∞—á -->
                <div class="subtasks-summary" id="subtasks-summary-{{.ID}}">
                    <span>üìã –ü–æ–¥–∑–∞–¥–∞—á–∏: </span>
                    <span class="subtasks-progress">
                        <span class="progress-text">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
                    </span>
                </div>
                
                <button class="toggle-subtasks-btn" onclick="toggleSubtasks('{{.ID}}')">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á–∏</button>
                
                <div class="subtasks" id="subtasks-{{.ID}}" style="display:none;">
                    <!-- –ü–æ–¥–∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                </div>
                
                <div class="subtask-input-container">
                    <input type="text" class="subtask-input" id="subtask-input-{{.ID}}" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É">
                    <button class="add-subtask-btn" onclick="addSubtask('{{.ID}}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                
                <div class="task-actions">
                    <form method="POST" action="/tasks/toggle/{{.ID}}" style="display:inline;">
                        <button type="submit" class="complete-button">
                            {{if .Completed}}‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ{{else}}‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ{{end}}
                        </button>
                    </form>
                    <button class="edit-button" onclick='showEditForm("{{.ID}}","{{.Description | js}}","{{.Priority}}","{{if not .DueDate.IsZero}}{{.DueDate.Format `2006-01-02`}}{{end}}","{{range $i,$tag:=.Tags}}{{if $i}},{{end}}{{$tag}}{{end}}")'>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <form method="POST" action="/tasks/delete/{{.ID}}" style="display:inline;">
                        <button type="submit" class="delete-button">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </div>
            </div>
            
            <form class="edit-form" id="edit-form-{{.ID}}" method="POST" action="/tasks/update/{{.ID}}">
                <input type="text" name="description" value="{{.Description}}" required style="flex-grow:1;">
                <select name="priority" style="width:120px;">
                    {{if eq .Priority "low"}}<option value="low" selected>–ù–∏–∑–∫–∏–π</option>{{else}}<option value="low">–ù–∏–∑–∫–∏–π</option>{{end}}
                    {{if eq .Priority "medium"}}<option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>{{else}}<option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>{{end}}
                    {{if eq .Priority "high"}}<option value="high" selected>–í—ã—Å–æ–∫–∏–π</option>{{else}}<option value="high">–í—ã—Å–æ–∫–∏–π</option>{{end}}
                </select>
                {{if not .DueDate.IsZero}}<input type="date" name="due_date" value="{{.DueDate.Format `2006-01-02`}}" style="width:150px;">{{else}}<input type="date" name="due_date" style="width:150px;">{{end}}
                <input type="text" name="tags" value="{{range $i,$tag:=.Tags}}{{if $i}},{{end}}{{$tag}}{{end}}" placeholder="—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" style="width:200px;">
                <button class="edit-button" type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="delete-button" onclick="hideEditForm('{{.ID}}')">‚úñ –û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
        {{end}}
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á
        function showEditForm(id, description, priority, dueDate, tags) {
            const taskElement = document.getElementById('task-' + id);
            if (!taskElement) return;
            
            const elementsToHide = [
                taskElement.querySelector('.task-description'),
                taskElement.querySelector('.task-info'),
                taskElement.querySelector('.tags-container'),
                taskElement.querySelector('.task-actions'),
                taskElement.querySelector('.toggle-subtasks-btn'),
                taskElement.querySelector('.subtasks'),
                taskElement.querySelector('.subtask-input-container'),
                taskElement.querySelector('.subtasks-summary')
            ];
            
            elementsToHide.forEach(el => {
                if (el) el.style.display = 'none';
            });
            
            const editForm = document.getElementById('edit-form-' + id);
            if (editForm) {
                editForm.style.display = 'flex';
                const descInput = editForm.querySelector('input[name="description"]');
                const prioritySelect = editForm.querySelector('select[name="priority"]');
                const dueDateInput = editForm.querySelector('input[name="due_date"]');
                const tagsInput = editForm.querySelector('input[name="tags"]');
                
                if (descInput) descInput.value = description || '';
                if (prioritySelect) prioritySelect.value = priority || 'medium';
                if (dueDateInput) dueDateInput.value = dueDate || '';
                if (tagsInput) tagsInput.value = tags || '';
                
                if (descInput) descInput.focus();
            }
        }

        function hideEditForm(id) {
            const taskElement = document.getElementById('task-' + id);
            if (!taskElement) return;
            
            const elementsToShow = [
                taskElement.querySelector('.task-description'),
                taskElement.querySelector('.task-info'),
                taskElement.querySelector('.tags-container'),
                taskElement.querySelector('.task-actions'),
                taskElement.querySelector('.toggle-subtasks-btn'),
                taskElement.querySelector('.subtask-input-container'),
                taskElement.querySelector('.subtasks-summary')
            ];
            
            elementsToShow.forEach(el => {
                if (el) el.style.display = el.classList.contains('tags-container') ? 'flex' : 
                                          el.classList.contains('task-info') ? 'flex' : 
                                          el.classList.contains('task-actions') ? 'flex' :
                                          el.classList.contains('subtask-input-container') ? 'flex' : 'block';
            });
            
            const editForm = document.getElementById('edit-form-' + id);
            if (editForm) editForm.style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–∑–∞–¥–∞—á–∏ –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã
            const subtasks = taskElement.querySelector('.subtasks');
            if (subtasks) subtasks.style.display = 'none';
            
            const toggleBtn = taskElement.querySelector('.toggle-subtasks-btn');
            if (toggleBtn) {
                toggleBtn.classList.remove('expanded');
                toggleBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á–∏';
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–∑–∞–¥–∞—á–∞–º–∏
        function updateSubtasksSummary(taskId, subtasks) {
            const summaryElement = document.getElementById(`subtasks-summary-${taskId}`);
            if (!summaryElement) return;
            
            const total = subtasks.length;
            const completed = subtasks.filter(st => st.completed).length;
            
            if (total === 0) {
                summaryElement.innerHTML = '<span>üìã –ü–æ–¥–∑–∞–¥–∞—á–∏: –Ω–µ—Ç</span>';
            } else {
                summaryElement.innerHTML = `
                    <span>üìã –ü–æ–¥–∑–∞–¥–∞—á–∏: </span>
                    <span class="subtasks-progress">
                        <span class="progress-text">${completed}/${total} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                        ${completed === total ? '‚úÖ' : '‚è≥'}
                    </span>
                `;
            }
        }

        function toggleSubtasks(taskId) {
            const subtasksContainer = document.getElementById(`subtasks-${taskId}`);
            const toggleBtn = document.querySelector(`#task-${taskId} .toggle-subtasks-btn`);
            
            if (subtasksContainer.style.display === 'none' || !subtasksContainer.style.display) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∑–∞–¥–∞—á–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
                if (subtasksContainer.innerHTML.trim() === '' || subtasksContainer.innerHTML.includes('–∑–∞–≥—Ä—É–∑–∫–∞')) {
                    loadSubtasks(taskId);
                }
                subtasksContainer.style.display = 'block';
                toggleBtn.classList.add('expanded');
                toggleBtn.textContent = '–°–∫—Ä—ã—Ç—å –ø–æ–¥–∑–∞–¥–∞—á–∏';
            } else {
                subtasksContainer.style.display = 'none';
                toggleBtn.classList.remove('expanded');
                toggleBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á–∏';
            }
        }

        function loadSubtasks(taskId) {
            fetch(`/tasks/${taskId}/subtasks`)
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∑–∞–¥–∞—á');
                    return response.json();
                })
                .then(subtasks => {
                    const container = document.getElementById(`subtasks-${taskId}`);
                    if (!container) return;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º summary
                    updateSubtasksSummary(taskId, subtasks);
                    
                    if (subtasks.length === 0) {
                        container.innerHTML = '<div style="color:#666;font-size:0.9em;padding:10px;">–ù–µ—Ç –ø–æ–¥–∑–∞–¥–∞—á</div>';
                        return;
                    }
                    
                    container.innerHTML = subtasks.map(subtask => `
                        <div class="subtask ${subtask.completed ? 'completed' : ''}" id="subtask-${subtask.id}">
                            <input type="checkbox" ${subtask.completed ? 'checked' : ''} 
                                   onchange="toggleSubtaskStatus(${subtask.id}, ${taskId})">
                            <span class="subtask-description">${subtask.description}</span>
                            <div class="subtask-actions">
                                <button onclick="deleteSubtask(${subtask.id}, ${taskId})" style="background:none;border:none;color:#f44336;cursor:pointer;padding:5px;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∑–∞–¥–∞—á:', error);
                    const container = document.getElementById(`subtasks-${taskId}`);
                    if (container) {
                        container.innerHTML = '<div style="color:#f44336;font-size:0.9em;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∑–∞–¥–∞—á</div>';
                    }
                });
        }

        function addSubtask(taskId) {
            const input = document.getElementById(`subtask-input-${taskId}`);
            const description = input.value.trim();
            if (!description) return;
            
            fetch(`/tasks/${taskId}/subtasks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `description=${encodeURIComponent(description)}`
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á–∏');
                input.value = '';
                return loadSubtasks(taskId);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É');
            });
        }

        function toggleSubtaskStatus(subtaskId, taskId) {
            fetch(`/subtasks/${subtaskId}/toggle`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á–∏');
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∑–∞–¥–∞—á–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                return loadSubtasks(taskId);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É');
            });
        }

        function deleteSubtask(subtaskId, taskId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É?')) return;
            
            fetch(`/subtasks/${subtaskId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á–∏');
                return loadSubtasks(taskId);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É');
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function setupDatePickers() {
            const createDatePicker = (inputId) => {
                const input = document.getElementById(inputId);
                if (!input) return;
                
                const wrapper = input.parentNode;
                const datePicker = document.createElement('input');
                datePicker.type = 'date';
                datePicker.style.position = 'absolute';
                datePicker.style.opacity = '0';
                datePicker.style.width = '30px';
                datePicker.style.height = '30px';
                datePicker.style.cursor = 'pointer';
                datePicker.title = "–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É";
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                if (input.value && input.value.match(/\d{2}\.\d{2}\.\d{4}/)) {
                    const [day, month, year] = input.value.split('.');
                    datePicker.value = `${year}-${month}-${day}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã
                datePicker.addEventListener('change', function() {
                    if (this.value) {
                        const [year, month, day] = this.value.split('-');
                        input.value = `${day}.${month}.${year}`;
                    }
                });
                
                wrapper.appendChild(datePicker);
            };
            
            createDatePicker('startDate');
            createDatePicker('endDate');
        }

        function showDatePicker(inputId) {
            const input = document.getElementById(inputId);
            if (input && input.parentNode) {
                const datePicker = input.parentNode.querySelector('input[type="date"]');
                if (datePicker) {
                    datePicker.showPicker();
                }
            }
        }

        // –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        function applyQuickFilter(filterType) {
            const form = document.getElementById('advancedFilterForm');
            if (!form) return;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            form.reset();
            
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const formatToRussian = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${day}.${month}.${date.getFullYear()}`;
            };
            
            switch(filterType) {
                case 'active_high':
                    form.elements['completed'].value = 'false';
                    form.elements['priority'].value = 'high';
                    break;
                case 'active_medium':
                    form.elements['completed'].value = 'false';
                    form.elements['priority'].value = 'medium';
                    break;
                case 'active_week':
                    form.elements['completed'].value = 'false';
                    form.elements['start_date'].value = formatToRussian(today);
                    form.elements['end_date'].value = formatToRussian(nextWeek);
                    form.elements['has_due_date'].value = 'true';
                    break;
                case 'no_date':
                    form.elements['has_due_date'].value = 'false';
                    break;
            }
            
            form.submit();
        }

        function resetAdvancedFilters() {
            const form = document.getElementById('advancedFilterForm');
            if (form) {
                form.reset();
            }
            window.location.href = '/';
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const form = document.getElementById('advancedFilterForm');
            
            if (form) {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ query string
                ['completed', 'priority', 'tags', 'start_date', 'end_date', 'has_due_date'].forEach(param => {
                    const value = urlParams.get(param);
                    if (value && form.elements[param]) {
                        form.elements[param].value = value;
                    }
                });
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–∏
                setupDatePickers();
            }
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
            highlightActiveFilters();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∑–∞–¥–∞—á–∏ –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
            document.querySelectorAll('.task').forEach(taskElement => {
                const taskId = taskElement.id.split('-')[1];
                loadSubtasks(taskId);
            });
        });

        function highlightActiveFilters() {
            const urlParams = new URLSearchParams(window.location.search);
            const filtersContainer = document.getElementById('advancedFilters');
            
            if (!filtersContainer) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            const hasActiveFilters = Array.from(urlParams.keys()).some(key => 
                key !== '' && urlParams.get(key) !== '' && 
                ['completed', 'priority', 'tags', 'start_date', 'end_date', 'has_due_date'].includes(key)
            );
            
            if (hasActiveFilters) {
                filtersContainer.classList.add('active');
            } else {
                filtersContainer.classList.remove('active');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–¥–∞—á–∏
        document.querySelector('.task-form').addEventListener('submit', function(e) {
            e.preventDefault();
            this.submit();
        });
    </script>
</body>
</html>